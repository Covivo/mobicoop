<template>
  <v-container fluid>
    <v-alert
      v-if="alertFail"
      type="error"
    >
      {{ $t('fail') }}
    </v-alert>       
    <v-row class="align-center">
      <v-col
        cols="2"
      >
        <ProfileAvatar :avatar="avatar" />
      </v-col>
      <v-col
        v-if="showReviewed"
        cols="2"
      >
        {{ reviewedName }}
      </v-col>
      <v-col :cols="showReviewed ? 6 : 8">
        <v-textarea
          v-model="content"
          :label="labelTxt"
          :rows="rows"
          required
        />
      </v-col>
      <v-col
        cols="2"
        class="text-right"
      >
        <v-btn
          color="primary"
          rounded
          :disabled="!content"
          :loading="loading"
          @click="leaveReview"
        >
          {{ $t("validate") }}
        </v-btn>
      </v-col>
    </v-row>
  </v-container>
</template>
<script>
import axios from "axios";
import {messages_en, messages_fr} from "@translations/components/utilities/Reviews/WriteReview";
import ProfileAvatar from "@components/user/profile/ProfileAvatar";
export default {
  i18n: {
    messages: {
      'en': messages_en,
      'fr': messages_fr
    }
  },
  components:{
    ProfileAvatar
  },
  props:{
    reviewer:{
      type: Object,
      default: null
    },
    reviewed:{
      type: Object,
      default: null
    },
    label:{
      type:String,
      default:null
    },
    rows:{
      type:Number,
      default:3
    },
    showReviewed:{
      type: Boolean,
      default: false
    }
  },
  data(){
    return{
      content:null,
      valid:false,
      loading:false,
      alertFail:false
    }
  },
  computed:{
    avatar(){
      if(this.reviewed.avatars){
        return this.reviewed.avatars[this.reviewed.avatars.length-1];
      }
      else{
        return this.reviewed.avatar;
      }
    },
    labelTxt(){
      if(this.label){
        return this.label;
      }
      else{
        return this.$t('label');
      }
    },
    reviewedName(){
      return this.reviewed.givenName+' '+this.reviewed.shortFamilyName;
    }
  },
  mounted(){
    this.snackbarSuccess = true;
  },
  methods:{
    leaveReview(){
      this.loading = true;
      let reviewData = {
        "reviewerId": this.reviewer.id,
        "reviewedId": this.reviewed.id,
        "content":this.content
      };
      axios.post(this.$t("leaveReviewUri"), reviewData)
        .then(response => {
          // console.error(response.data);
          this.loading = false;
          if(response.data.success){
            this.$emit("reviewLeft",{'success':response.data});
          }
          else{
            this.alertFail = true;
          }
        })
        .catch(function (error) {
          console.error(error);
        });    
    }
  }
}
</script>