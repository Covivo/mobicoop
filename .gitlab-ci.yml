image: docker:20.10.10

stages:
  - build
  

###############
# BUILD STAGE #
###############

# API PHP evolution build
build-api-php-evolution:
  stage: build
  services:
    - docker:dind
  before_script:
    - echo "$EVOLUTION_CI_REGISTRY_PASSWORD" | docker login -u "$EVOLUTION_CI_REGISTRY_USER" --password-stdin $EVOLUTION_CI_REGISTRY
  script:
    - echo "${SSH_TEST_PRIVATE_KEY}" > id_rsa
    - chmod 700 id_rsa
    - mkdir -p ${HOME}/.ssh
    - mv id_rsa ${HOME}/.ssh
    - echo "${SSH_TEST_HOST_KEY}" > "${HOME}/.ssh/known_hosts"
    - scp -o StrictHostKeyChecking=no ${SSH_TEST_USER}@${SSH_TEST_IP}:"${EVOLUTION_CI_INSTANCE_PATH}/${EVOLUTION_CI_INSTANCE_PATH_API}/.env.dev.local" ./api/
    - docker build --pull --target mobicoop_platform_api_php -t "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_PHP" ./api/
    - docker push "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_PHP"
  only:
    - mobicoopPlatformEvolution
  when: manual

# API NGINX evolution build
build-api-nginx-evolution:
  stage: build
  services:
    - docker:dind
  before_script:
    - echo "$EVOLUTION_CI_REGISTRY_PASSWORD" | docker login -u "$EVOLUTION_CI_REGISTRY_USER" --password-stdin $EVOLUTION_CI_REGISTRY
  script:
    - docker build --pull --target mobicoop_platform_api_nginx -t "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_NGINX" ./api/
    - docker push "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_NGINX"    
  only:
    - mobicoopPlatformEvolution
  when: manual

