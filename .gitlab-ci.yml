image: docker:20.10.16

stages:
  - build
  

###############
# BUILD STAGE #
###############

# API PHP evolution build
build-api-php-evolution:
  stage: build
  services:
    - docker:20.10.16-dind
  before_script:
    - echo "$EVOLUTION_CI_REGISTRY_PASSWORD" | docker login -u "$EVOLUTION_CI_REGISTRY_USER" --password-stdin $EVOLUTION_CI_REGISTRY
  script:
    - docker build --pull --target mobicoop_platform_api_php -t "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_API_PHP" ./api/
    - docker push "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_API_PHP"
  only:
    - mobicoopPlatformEvolution
  when: manual

# API NGINX evolution build
build-api-nginx-evolution:
  stage: build
  services:
    - docker:20.10.16-dind
  before_script:
    - echo "$EVOLUTION_CI_REGISTRY_PASSWORD" | docker login -u "$EVOLUTION_CI_REGISTRY_USER" --password-stdin $EVOLUTION_CI_REGISTRY
  script:
    - docker build --pull --target mobicoop_platform_api_nginx -t "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_API_NGINX" ./api/
    - docker push "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_API_NGINX"    
  only:
    - mobicoopPlatformEvolution
  when: manual

# CLIENT PHP evolution build
build-client-php-evolution:
  stage: build
  services:
    - docker:20.10.16-dind
  before_script:
    - apk --update add nodejs npm
    - cd client && npm install && npm run compile
    - echo "$EVOLUTION_CI_REGISTRY_PASSWORD" | docker login -u "$EVOLUTION_CI_REGISTRY_USER" --password-stdin $EVOLUTION_CI_REGISTRY
  script:
    - docker build --pull --target mobicoop_platform_client_php -t "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_CLIENT_PHP" ./client/
    - docker push "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_CLIENT_PHP"
  only:
    - mobicoopPlatformEvolution
  when: manual

# CLIENT NGINX evolution build
build-client-nginx-evolution:
  stage: build
  services:
    - docker:20.10.16-dind
  before_script:
    - echo "$EVOLUTION_CI_REGISTRY_PASSWORD" | docker login -u "$EVOLUTION_CI_REGISTRY_USER" --password-stdin $EVOLUTION_CI_REGISTRY
  script:
    - docker build --pull --target mobicoop_platform_client_nginx -t "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_CLIENT_NGINX" ./client/
    - docker push "$EVOLUTION_CI_REGISTRY$EVOLUTION_CI_REGISTRY_PROJECT$EVOLUTION_CI_REGISTRY_IMAGE_CLIENT_NGINX"    
  only:
    - mobicoopPlatformEvolution
  when: manual
